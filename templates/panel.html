{% extends 'base.html' %}
{% block title %}Panel prowadzącego{% endblock %}
{% block content %}
  <div aria-live="polite" role="status">
    {% with messages = get_flashed_messages(with_categories=True) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }}" role="alert">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}
  </div>

  <h2 class="mb-4">Moje dane</h2>
  <form method="POST" action="{{ url_for('routes.panel_update_profile') }}" enctype="multipart/form-data" class="mb-5">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <div class="row g-3">
      <div class="col-md-4">
        <label for="imie" class="form-label">Imię:</label>
        <input type="text" class="form-control" id="imie" name="imie" value="{{ prowadzacy.imie }}">
      </div>
      <div class="col-md-4">
        <label for="nazwisko" class="form-label">Nazwisko:</label>
        <input type="text" class="form-control" id="nazwisko" name="nazwisko" value="{{ prowadzacy.nazwisko }}">
      </div>
      <div class="col-md-4">
        <label for="numer_umowy" class="form-label">Numer umowy:</label>
        <input type="text" class="form-control" id="numer_umowy" name="numer_umowy" value="{{ prowadzacy.numer_umowy }}">
      </div>
      <div class="col-md-4">
        <label for="domyslny_czas" class="form-label">Domyślny czas zajęć:</label>
        <input type="text" class="form-control" id="domyslny_czas" name="domyslny_czas" value="{{ domyslny_czas }}">
      </div>
      <div class="col-md-6">
        <label for="podpis" class="form-label">Podpis (.png/.jpg):</label>
        <input type="file" class="form-control" id="podpis" name="podpis" accept=".png,.jpg,.jpeg">
        {% if prowadzacy.podpis_filename %}
          <img src="{{ url_for('static', filename=prowadzacy.podpis_filename) }}"
               alt="Aktualny podpis"
               class="img-thumbnail mt-2"
               style="height: 60px;">
        {% endif %}
        <img id="podpisPreview" class="img-thumbnail mt-2 d-none" alt="Podgląd podpisu">
      </div>
    </div>
    <div class="mt-3">
      <button type="submit" class="btn btn-primary">Zapisz dane</button>
    </div>
  </form>

  <h2 class="mb-4">Uczestnicy</h2>
  <form method="POST" action="{{ url_for('routes.dodaj_uczestnika') }}" class="mb-3 d-flex">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <input type="text" class="form-control me-2" name="new_participant" placeholder="Imię i nazwisko">
      <button type="submit" class="btn btn-primary">Dodaj</button>
  </form>

  <ul class="list-group mb-3">
    {% for u in uczestnicy %}
    <li class="list-group-item">
      <div class="d-flex align-items-center justify-content-between">
        <form action="{{ url_for('routes.zmien_uczestnika', id=u.id) }}" method="post" class="d-flex align-items-center flex-grow-1 me-2">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="text" name="new_name" value="{{ u.imie_nazwisko }}" class="form-control form-control-sm me-2">
          <span class="me-2">{{ stats[u.id].present }}/{{ total_sessions }} ({{ '%.0f'|format(stats[u.id].percent) }}%)</span>
          <button type="submit" class="btn btn-sm text-secondary" aria-label="Zapisz">
            <i class="bi bi-check"></i>
          </button>
        </form>
        <form action="{{ url_for('routes.usun_uczestnika', id=u.id) }}" method="post" class="ms-2">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="submit" class="btn btn-sm text-danger" aria-label="Usuń">
            <i class="bi bi-x"></i>
          </button>
        </form>
      </div>
    </li>
    {% endfor %}
  </ul>

  <p>
    <a href="{{ url_for('routes.panel_statystyki') }}" class="btn btn-outline-secondary">Statystyki obecności</a>
  </p>

  <h2 class="mb-4">Raporty miesięczne</h2>
  <table class="table table-striped table-hover mb-5">
    <thead class="table-secondary">
      <tr>
        <th>Rok</th>
        <th>Miesiąc</th>
        <th>Godzin</th>
        <th>Akcja</th>
      </tr>
    </thead>
    <tbody>
      {% for (rok, miesiac), godziny in podsumowanie|dictsort(reverse=True) %}
      <tr>
        <td>{{ rok }}</td>
        <td>{{ '%02d'|format(miesiac) }}</td>
        <td>{{ godziny }}</td>
        <td class="text-nowrap">
          <a href="{{ url_for('routes.panel_raport') }}?rok={{ rok }}&miesiac={{ miesiac }}" class="btn btn-sm text-primary">Pobierz</a>
          <a href="{{ url_for('routes.panel_raport') }}?rok={{ rok }}&miesiac={{ miesiac }}&wyslij=1" class="btn btn-sm text-secondary">Wyślij</a>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <h2 class="mb-4">Historia zajęć</h2>
  <table class="table table-striped table-hover">
    <thead class="table-secondary">
      <tr>
        <th>Data</th>
        <th>Czas</th>
        <th>Obecni</th>
        <th>Akcja</th>
        <th>Wysłano</th>
      </tr>
    </thead>
    <tbody>
      {% for z in zajecia %}
      <tr>
        <td>{{ z.data.date() }}</td>
        <td>{{ z.czas_trwania }}</td>
        <td>{{ z.obecni|length }}/{{ z.prowadzacy.uczestnicy|length }}</td>
        <td class="text-nowrap">
          <a href="{{ url_for('routes.panel_edytuj_zajecie', id=z.id) }}" class="btn btn-sm" aria-label="Edytuj zajęcia">
            <i class="bi bi-pencil"></i>
            <span class="visually-hidden">Edytuj zajęcia</span>
          </a>
          <a href="{{ url_for('routes.pobierz_zajecie', id=z.id) }}" class="btn btn-sm text-primary" aria-label="Pobierz dokument">
            <i class="bi bi-download"></i>
            <span class="visually-hidden">Pobierz dokument</span>
          </a>
          <a href="{{ url_for('routes.wyslij_zajecie', id=z.id) }}" class="btn btn-sm text-secondary" aria-label="Wyślij dokument mailem">
            <i class="bi bi-envelope"></i>
            <span class="visually-hidden">Wyślij dokument mailem</span>
          </a>
          <form action="{{ url_for('routes.usun_moje_zajecie', id=z.id) }}" method="POST" class="d-inline" onsubmit="return confirm('Usunąć zajęcia?')">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-sm text-danger" aria-label="Usuń zajęcia">
              <i class="bi bi-trash"></i>
              <span class="visually-hidden">Usuń zajęcia</span>
            </button>
          </form>
        </td>
        <td>
          {% if z.wyslano %}
          <i class="bi bi-check-lg text-success"></i>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

{% endblock %}
