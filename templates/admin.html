<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Panel administratora – ShareOKO</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body class="bg-light">
  <a href="#main" class="visually-hidden-focusable">Przejdź do głównej zawartości</a>

  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <span class="navbar-brand">Panel administratora</span>
      <div class="d-flex">
        <a href="{{ url_for('routes.index') }}" class="btn btn-outline-light me-2">Powrót</a>
        <a href="{{ url_for('routes.logout') }}" class="btn btn-outline-danger">Wyloguj</a>
      </div>
    </div>
  </nav>

  <main id="main" class="container mt-5 mb-5">
    {% if new_users %}
    <h2 class="mb-4">Konta oczekujące na zatwierdzenie</h2>
    <table class="table table-bordered align-middle">
      <thead class="table-warning">
        <tr>
          <th>ID</th>
          <th>Login</th>
          <th>Imię i nazwisko</th>
          <th>Akcja</th>
        </tr>
      </thead>
      <tbody>
        {% for u in new_users %}
        <tr>
          <td>{{ u.id }}</td>
          <td>{{ u.login }}</td>
          <td>{{ u.prowadzacy.imie }} {{ u.prowadzacy.nazwisko }}</td>
          <td>
            <form action="{{ url_for('routes.approve_user', id=u.id) }}" method="POST" class="d-inline">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button type="submit" class="btn btn-sm btn-success">Akceptuj</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <hr class="my-4">
    {% endif %}

    <h2 class="mb-4">Lista prowadzących</h2>

    {% with messages = get_flashed_messages(with_categories=True) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} mt-3" role="alert">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <table class="table table-striped table-bordered align-middle">
      <thead class="table-dark">
        <tr>
          <th>ID</th>
          <th>Imię i nazwisko</th>
          <th>Podpis</th>
          <th>Uczestnicy</th>
          <th>Akcje</th>
        </tr>
      </thead>
      <tbody>
        {% for p in prowadzacy %}
        <tr>
          <td>{{ p.id }}</td>
          <td>{{ p.imie }} {{ p.nazwisko }}</td>
          <td>
            {% if p.podpis_filename %}
              <img src="{{ url_for('static', filename=p.podpis_filename) }}" alt="Podpis" style="height: 40px;">
            {% else %}
              Brak
            {% endif %}
          </td>
          <td>
            <ul class="mb-0">
              {% for u in p.uczestnicy %}
                <li>{{ u.imie_nazwisko }}</li>
              {% endfor %}
            </ul>
          </td>
          <td class="text-nowrap">
            <button class="btn btn-sm" onclick="edytujProwadzacego({{ p.id }}, '{{ p.imie }}', '{{ p.nazwisko }}', '{{ p.numer_umowy }}', [{% for u in p.uczestnicy %}'{{ u.imie_nazwisko }}'{% if not loop.last %}, {% endif %}{% endfor %}])" aria-label="Edytuj prowadzącego">
              <i class="bi bi-pencil"></i>
            </button>
            <form action="{{ url_for('routes.usun_prowadzacego', id=p.id) }}" method="POST" class="d-inline" onsubmit="return confirm('Na pewno usunąć?')">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button type="submit" class="btn btn-sm text-danger" aria-label="Usuń prowadzącego"><i class="bi bi-trash"></i></button>
            </form>
            <button class="btn btn-sm text-primary" data-bs-toggle="modal" data-bs-target="#raportModal{{ p.id }}" aria-label="Raport miesięczny">
              <i class="bi bi-file-earmark-text"></i>
            </button>
          </td>
        </tr>

        <div class="modal fade" id="raportModal{{ p.id }}" tabindex="-1" aria-labelledby="raportModalLabel{{ p.id }}" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <form method="GET" action="{{ url_for('routes.raport', prowadzacy_id=p.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-header">
                  <h5 class="modal-title" id="raportModalLabel{{ p.id }}">Raport miesięczny</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zamknij"></button>
                </div>
                <div class="modal-body">
                  <div class="mb-3">
                    <label for="miesiac{{ p.id }}" class="form-label">Miesiąc:</label>
                    <input type="number" class="form-control" id="miesiac{{ p.id }}" name="miesiac" value="{{ ostatnie[p.id].month if p.id in ostatnie }}" required>
                  </div>
                  <div class="mb-3">
                    <label for="rok{{ p.id }}" class="form-label">Rok:</label>
                    <input type="number" class="form-control" id="rok{{ p.id }}" name="rok" value="{{ ostatnie[p.id].year if p.id in ostatnie }}" required>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="submit" class="btn btn-primary">Pobierz</button>
                  <button type="submit" name="wyslij" value="1" class="btn btn-outline-secondary">Wyślij mailem</button>
                </div>
              </form>
            </div>
          </div>
        </div>
        {% endfor %}
      </tbody>
    </table>

    <hr class="my-5">

    <h2 class="mb-4">Historia zajęć</h2>

    <table class="table table-striped table-hover">
      <thead class="table-secondary">
        <tr>
          <th>Data</th>
          <th>Czas trwania</th>
          <th>Prowadzący</th>
          <th>Obecni</th>
          <th>Akcja</th>
        </tr>
      </thead>
      <tbody>
        {% for z in zajecia %}
        <tr>
          <td>{{ z.data }}</td>
          <td>{{ z.czas_trwania }}</td>
          <td>{{ z.prowadzacy.imie }} {{ z.prowadzacy.nazwisko }}</td>
          <td>
            <ul class="mb-0">
              {% for o in z.obecni %}
                <li>{{ o.imie_nazwisko }}</li>
              {% endfor %}
            </ul>
          </td>
          <td>
            <form action="{{ url_for('routes.usun_zajecie', id=z.id) }}" method="POST" class="d-inline" onsubmit="return confirm('Na pewno usunąć zajęcia?')">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button type="submit" class="btn btn-sm text-danger" aria-label="Usuń zajęcia"><i class="bi bi-trash"></i></button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </main>

  <div class="modal fade" id="dodajModal" tabindex="-1" aria-labelledby="dodajModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form method="POST" action="/dodaj" enctype="multipart/form-data">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <div class="modal-header">
            <h5 class="modal-title" id="dodajModalLabel">Dodaj / Edytuj prowadzącego</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zamknij"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" name="edit_id" id="edit_id">
            <div class="mb-3">
              <label for="nowy_imie" class="form-label">Imię prowadzącego:</label>
              <input type="text" class="form-control" id="nowy_imie" name="nowy_imie" required>
            </div>
            <div class="mb-3">
              <label for="nowy_nazwisko" class="form-label">Nazwisko prowadzącego:</label>
              <input type="text" class="form-control" id="nowy_nazwisko" name="nowy_nazwisko" required>
            </div>
            <div class="mb-3">
              <label for="nowy_umowa" class="form-label">Numer umowy:</label>
              <input type="text" class="form-control" id="nowy_umowa" name="nowy_umowa" required>
            </div>
            <div class="mb-3">
              <label for="nowi_uczestnicy" class="form-label">Uczestnicy (po jednym na linię):</label>
              <textarea class="form-control" id="nowi_uczestnicy" name="nowi_uczestnicy" rows="5" required></textarea>
            </div>
            <div class="mb-3">
              <label for="nowy_podpis" class="form-label">Plik podpisu (.png lub .jpg):</label>
              <input class="form-control" type="file" name="nowy_podpis" id="nowy_podpis" accept=".png,.jpg,.jpeg">
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-success">Zapisz prowadzącego</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function edytujProwadzacego(id, imie, nazwisko, umowa, uczestnicy) {
      document.getElementById("edit_id").value = id;
      document.getElementById("nowy_imie").value = imie;
      document.getElementById("nowy_nazwisko").value = nazwisko;
      document.getElementById("nowy_umowa").value = umowa;
      document.getElementById("nowi_uczestnicy").value = uczestnicy.join("\n");
      const modal = new bootstrap.Modal(document.getElementById('dodajModal'));
      modal.show();
    }
  </script>
</body>
</html>
