{% extends 'base.html' %}
{% block title %}Panel administratora{% endblock %}
{% block content %}
  {% if new_users %}
  <h2 class="mb-4">Konta oczekujące na zatwierdzenie</h2>
  <table class="table table-bordered align-middle">
    <thead class="table-warning">
      <tr>
        <th>ID</th>
        <th>Login</th>
        <th>Imię i nazwisko</th>
        <th>Akcja</th>
      </tr>
    </thead>
    <tbody>
      {% for u in new_users %}
      <tr>
        <td>{{ u.id }}</td>
        <td>{{ u.login }}</td>
        <td>{{ u.prowadzacy.imie }} {{ u.prowadzacy.nazwisko }}</td>
        <td>
          <form action="{{ url_for('routes.approve_user', id=u.id) }}" method="POST" class="d-inline">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-sm btn-success">Akceptuj</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  <hr class="my-4">
  {% endif %}

  <h2 class="mb-4">Lista prowadzących</h2>

  <div aria-live="polite" role="status">
    {% with messages = get_flashed_messages(with_categories=True) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} mt-3" role="alert">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}
  </div>

  <table class="table table-striped table-bordered align-middle">
    <thead class="table-dark">
      <tr>
        <th>ID</th>
        <th>Imię i nazwisko</th>
        <th>Podpis</th>
        <th>Uczestnicy</th>
        <th>Akcje</th>
      </tr>
    </thead>
    <tbody>
      {% for p in prowadzacy %}
      <tr>
        <td>{{ p.id }}</td>
        <td>{{ p.imie }} {{ p.nazwisko }}</td>
        <td>
          {% if p.podpis_filename %}
            <img src="{{ url_for('static', filename=p.podpis_filename) }}" alt="Podpis" style="height: 40px;">
          {% else %}
            Brak
          {% endif %}
        </td>
        <td>{{ p.uczestnicy|length }}</td>
        <td class="text-nowrap">
          <button class="btn btn-sm" onclick="edytujProwadzacego({{ p.id }}, '{{ p.imie }}', '{{ p.nazwisko }}', '{{ p.numer_umowy }}')" aria-label="Edytuj prowadzącego">
            <i class="bi bi-pencil"></i>
            <span class="visually-hidden">Edytuj prowadzącego</span>
          </button>
          <a href="{{ url_for('routes.admin_trainer', id=p.id) }}" class="btn btn-sm text-secondary" aria-label="Uczestnicy">
            <i class="bi bi-people"></i>
            <span class="visually-hidden">Uczestnicy</span>
          </a>
          <a href="{{ url_for('routes.admin_statystyki', trainer_id=p.id) }}" class="btn btn-sm text-info" aria-label="Statystyki">
            <i class="bi bi-bar-chart"></i>
            <span class="visually-hidden">Statystyki</span>
          </a>
          <form action="{{ url_for('routes.usun_prowadzacego', id=p.id) }}" method="POST" class="d-inline" onsubmit="return confirm('Na pewno usunąć?')">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-sm text-danger" aria-label="Usuń prowadzącego">
              <i class="bi bi-trash"></i>
              <span class="visually-hidden">Usuń prowadzącego</span>
            </button>
          </form>
          <button class="btn btn-sm text-primary" data-bs-toggle="modal" data-bs-target="#raportModal{{ p.id }}" aria-label="Raport miesięczny">
            <i class="bi bi-file-earmark-text"></i>
            <span class="visually-hidden">Raport miesięczny</span>
          </button>
        </td>
      </tr>

      <div class="modal fade" id="raportModal{{ p.id }}" tabindex="-1" aria-labelledby="raportModalLabel{{ p.id }}" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <form method="GET" action="{{ url_for('routes.raport', prowadzacy_id=p.id) }}">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <div class="modal-header">
                <h5 class="modal-title" id="raportModalLabel{{ p.id }}">Raport miesięczny</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zamknij"></button>
              </div>
              <div class="modal-body">
                <div class="form-floating mb-3">
                  <input type="number" class="form-control" id="miesiac{{ p.id }}" name="miesiac" placeholder="Miesiąc" value="{{ ostatnie[p.id].month if p.id in ostatnie }}" required tabindex="1">
                  <label for="miesiac{{ p.id }}">Miesiąc:</label>
                </div>
                <div class="form-floating mb-3">
                  <input type="number" class="form-control" id="rok{{ p.id }}" name="rok" placeholder="Rok" value="{{ ostatnie[p.id].year if p.id in ostatnie }}" required tabindex="2">
                  <label for="rok{{ p.id }}">Rok:</label>
                </div>
              </div>
              <div class="modal-footer">
                <button type="submit" class="btn btn-primary" tabindex="3">Pobierz</button>
                <button type="submit" name="wyslij" value="1" class="btn btn-outline-secondary" tabindex="4">Wyślij mailem</button>
              </div>
            </form>
          </div>
        </div>
      </div>
      {% endfor %}
    </tbody>
  </table>

  <hr class="my-5">

  <h2 class="mb-4">Historia zajęć</h2>

  <form method="get" class="mb-3">
    <div class="row g-2 align-items-end">
      <div class="col-auto">
        <label for="p_id" class="form-label">Prowadzący:</label>
      </div>
      <div class="col-auto">
        <select name="p_id" id="p_id" class="form-select">
          <option value="" {% if not selected_p_id %}selected{% endif %}>Wszyscy</option>
          {% for p in prowadzacy %}
          <option value="{{ p.id }}" {% if selected_p_id and p.id == selected_p_id %}selected{% endif %}>{{ p.imie }} {{ p.nazwisko }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-auto">
        <button type="submit" class="btn btn-primary">Filtruj</button>
      </div>
    </div>
  </form>

  <table class="table table-striped table-hover">
    <thead class="table-secondary">
      <tr>
        <th>Data</th>
        <th>Czas trwania</th>
        <th>Prowadzący</th>
        <th>Obecni</th>
        <th>Akcja</th>
        <th>Wysłano</th>
      </tr>
    </thead>
    <tbody>
      {% for z in zajecia %}
      <tr>
        <td>{{ z.data.date() }}</td>
        <td>{{ z.czas_trwania }}</td>
        <td>{{ z.prowadzacy.imie }} {{ z.prowadzacy.nazwisko }}</td>
        <td>{{ z.obecni|length }}/{{ z.prowadzacy.uczestnicy|length }}</td>
        <td class="text-nowrap">
          <a href="{{ url_for('routes.edytuj_zajecie', id=z.id) }}" class="btn btn-sm" aria-label="Edytuj zajęcia">
            <i class="bi bi-pencil"></i>
            <span class="visually-hidden">Edytuj zajęcia</span>
          </a>
          <a href="{{ url_for('routes.pobierz_zajecie_admin', id=z.id) }}" class="btn btn-sm text-primary" aria-label="Pobierz dokument">
            <i class="bi bi-download"></i>
            <span class="visually-hidden">Pobierz dokument</span>
          </a>
          <a href="{{ url_for('routes.wyslij_zajecie_admin', id=z.id) }}" class="btn btn-sm text-secondary" aria-label="Wyślij dokument mailem">
            <i class="bi bi-envelope"></i>
            <span class="visually-hidden">Wyślij dokument mailem</span>
          </a>
          <form action="{{ url_for('routes.usun_zajecie', id=z.id) }}" method="POST" class="d-inline" onsubmit="return confirm('Na pewno usunąć zajęcia?')">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-sm text-danger" aria-label="Usuń zajęcia">
              <i class="bi bi-trash"></i>
              <span class="visually-hidden">Usuń zajęcia</span>
            </button>
          </form>
        </td>
        <td>
          {% if z.wyslano %}
          <i class="bi bi-check-lg text-success"></i>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <nav aria-label="Paginacja" class="mt-3">
    <ul class="pagination">
      {% if pagination.has_prev %}
      <li class="page-item">
        <a class="page-link" href="{{ url_for('routes.admin_dashboard', p_id=selected_p_id, page=pagination.prev_num) }}">Poprzednia</a>
      </li>
      {% else %}
      <li class="page-item disabled"><span class="page-link">Poprzednia</span></li>
      {% endif %}
      <li class="page-item disabled"><span class="page-link">{{ pagination.page }}/{{ pagination.pages }}</span></li>
      {% if pagination.has_next %}
      <li class="page-item">
        <a class="page-link" href="{{ url_for('routes.admin_dashboard', p_id=selected_p_id, page=pagination.next_num) }}">Następna</a>
      </li>
      {% else %}
      <li class="page-item disabled"><span class="page-link">Następna</span></li>
      {% endif %}
    </ul>
  </nav>

  {% include '_trainer_modal.html' %}
{% endblock %}
{% block scripts %}
  {% include '_trainer_modal_script.html' %}
{% endblock %}
